<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga Formatter ‚Äî CBZ to XTC</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>üìö Manga Formatter</h1>
            <p class="subtitle">Convert CBZ manga to XTC format</p>
        </header>

        <!-- Phase 1: Main Form -->
        <form id="convertForm" enctype="multipart/form-data">
            <!-- Title -->
            <div class="form-group">
                <label for="title">Manga Title</label>
                <input type="text" id="title" name="title" placeholder="e.g. Hunter X Hunter" required>
            </div>

            <!-- Source Mode Toggle -->
            <div class="form-group">
                <label>Source</label>
                <div class="source-toggle">
                    <button type="button" class="source-btn" data-mode="upload">üì§ Upload Files</button>
                    <button type="button" class="source-btn active" data-mode="browse">üìÇ Browse</button>
                </div>
            </div>

            <!-- Upload Zone (shown in upload mode) -->
            <div class="form-group" id="uploadSection" style="display:none;">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <span class="drop-icon">üìÅ</span>
                        <p>Drag & drop CBZ files here</p>
                        <p class="drop-hint">or click to browse</p>
                    </div>
                    <input type="file" id="cbzFiles" name="cbz_files" multiple accept=".cbz" class="file-input">
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Directory Browser (shown in browse mode) -->
            <div class="form-group" id="browseSection">
                <div class="browser-panel">
                    <div class="browser-breadcrumb" id="breadcrumb"></div>
                    <div class="browser-list" id="browserList">
                        <p class="browser-loading">Loading‚Ä¶</p>
                    </div>
                    <div class="browser-actions" id="browserActions" style="display:none;">
                        <button type="button" id="selectDirBtn" class="btn-scan">üìÇ Select This Directory</button>
                    </div>
                </div>

                <!-- Selected dir info -->
                <div class="selected-dir-info" id="selectedDirInfo" style="display:none;">
                    <div class="selected-dir-header">
                        <span id="selectedDirLabel"></span>
                        <button type="button" id="changeDirBtn" class="btn-change">Change</button>
                    </div>
                    <div class="file-list" id="cbzPreviewList"></div>
                </div>
            </div>

            <!-- Settings -->
            <details class="settings-panel">
                <summary>‚öôÔ∏è Conversion Settings</summary>
                <div class="settings-grid">
                    <div class="setting">
                        <label for="dithering">Dithering</label>
                        <div class="toggle-wrap">
                            <input type="checkbox" id="dithering" name="dithering" checked>
                            <label for="dithering" class="toggle"></label>
                            <span class="toggle-label" id="ditherLabel">ON</span>
                        </div>
                    </div>

                    <div class="setting">
                        <label for="contrast">Contrast <span id="contrastVal" class="badge">4</span></label>
                        <input type="range" id="contrast" name="contrast" min="0" max="8" value="4">
                    </div>

                    <div class="setting">
                        <label for="target_width">Width (px)</label>
                        <input type="number" id="target_width" name="target_width" value="480" min="100" max="2000">
                    </div>

                    <div class="setting">
                        <label for="target_height">Height (px)</label>
                        <input type="number" id="target_height" name="target_height" value="800" min="100" max="2000">
                    </div>
                </div>
            </details>

            <!-- Submit -->
            <button type="submit" id="submitBtn" class="btn-primary" disabled>
                <span class="btn-text">Convert & Download</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span> Converting‚Ä¶
                </span>
            </button>
        </form>

        <!-- Phase 2: Review Panel (hidden initially) -->
        <div class="review-panel" id="reviewPanel" style="display:none;">
            <h2>üìã Manual Chapter Assignment</h2>
            <p class="review-intro">The following files couldn't be auto-assigned chapter numbers. Please review and
                assign them.</p>

            <div class="recognized-summary" id="recognizedSummary"></div>

            <div class="review-grid" id="reviewGrid"></div>

            <button type="button" id="continueBtn" class="btn-primary">
                <span class="btn-text">Continue & Download</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span> Processing‚Ä¶
                </span>
            </button>
        </div>

        <!-- Progress / Status -->
        <div class="status-bar" id="statusBar" style="display:none;">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="status-text" id="statusText">Processing‚Ä¶</p>
            <div class="progress-log" id="progressLog" style="display:none;"></div>
        </div>

        <!-- Error -->
        <div class="error-msg" id="errorMsg" style="display:none;"></div>
    </div>

    <script>
        // --- DOM refs ---
        const form = document.getElementById('convertForm');
        // ... (existing refs) ...
        const progressLog = document.getElementById('progressLog');

        // ... (existing code: dom refs, source toggle, browser, settings) ...

        // --- Form Submit ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.style.display = 'none';

            const title = document.getElementById('title').value.trim();
            if (!title) { showError('Please enter a manga title.'); return; }

            if (sourceMode === 'upload' && !fileInput.files.length) {
                showError('Please select CBZ files.'); return;
            }
            if (sourceMode === 'browse' && !selectedHostPath) {
                showError('Please select a directory.'); return;
            }

            const fd = new FormData();
            fd.append('title', title);
            fd.append('source_mode', sourceMode === 'browse' ? 'hostdir' : 'upload');
            fd.append('dithering', ditherToggle.checked ? 'true' : 'false');
            fd.append('contrast', contrastSlider.value);
            fd.append('target_width', document.getElementById('target_width').value);
            fd.append('target_height', document.getElementById('target_height').value);

            if (sourceMode === 'upload') {
                for (const f of fileInput.files) {
                    fd.append('cbz_files', f);
                }
            } else {
                fd.append('host_path', selectedHostPath);
            }

            setLoading(true);

            try {
                const resp = await fetch('/convert', { method: 'POST', body: fd });

                // Content-Type check
                const contentType = resp.headers.get('content-type') || '';

                if (contentType.includes('application/json')) {
                    // Immediate JSON response (Error or Needs Review)
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Conversion failed');

                    if (data.status === 'needs_review') {
                        showReviewPanel(data);
                        setLoading(false);
                        form.style.display = 'none';
                        return;
                    }
                } else if (contentType.includes('application/x-ndjson')) {
                    // Streaming response
                    await consumeStream(resp);
                } else {
                    throw new Error('Unexpected response type');
                }

            } catch (err) {
                showError(err.message);
                statusBar.style.display = 'none';
            } finally {
                if (statusBar.style.display === 'none') setLoading(false);
            }
        });

        // --- Stream Consumer ---
        async function consumeStream(resp) {
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            statusText.textContent = 'Starting conversion...';
            progressFill.classList.remove('indeterminate');
            progressFill.style.width = '0%';
            progressLog.style.display = 'block';
            progressLog.innerHTML = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep partial line

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            handleStreamMessage(msg);
                        } catch (e) {
                            console.error('Invalid JSON line:', line);
                        }
                    }
                }
            } catch (err) {
                showError('Stream error: ' + err.message);
            } finally {
                setLoading(false);
            }
        }

        function handleStreamMessage(msg) {
            if (msg.type === 'progress') {
                const pct = Math.round((msg.current / msg.total) * 100);
                progressFill.style.width = `${pct}%`;
                statusText.textContent = msg.message;

                // Add log entry
                const entry = document.createElement('div');
                entry.textContent = `[${pct}%] ${msg.message}`;
                progressLog.appendChild(entry);
                progressLog.scrollTop = progressLog.scrollHeight;

            } else if (msg.type === 'done') {
                statusText.textContent = '‚úÖ Conversion Complete!';
                progressFill.style.width = '100%';

                // Trigger download
                const a = document.createElement('a');
                a.href = msg.download_url;
                a.download = '';
                document.body.appendChild(a);
                a.click();
                a.remove();

            } else if (msg.type === 'error') {
                showError(msg.message);
            }
        }

        // --- Review Panel ---
        function showReviewPanel(data) {
            reviewPanel.style.display = '';
            if (data.recognized_count > 0) {
                recognizedSummary.innerHTML =
                    `<p class="recognized-info">‚úÖ <strong>${data.recognized_count}</strong> chapter${data.recognized_count !== 1 ? 's' : ''} auto-recognized: ${data.recognized_chapters.join(', ')}</p>`;
            } else {
                recognizedSummary.innerHTML = '<p class="recognized-info">No chapters were auto-recognized.</p>';
            }
            reviewGrid.innerHTML = '';
            for (const item of data.unrecognized) {
                const card = document.createElement('div');
                card.className = 'review-card';
                card.innerHTML = `
                    <img src="${item.preview_url}" alt="${item.filename}" class="review-thumb" loading="lazy">
                    <div class="review-info">
                        <span class="review-filename">${item.filename}</span>
                        <div class="review-input-wrap">
                            <label>Chapter #</label>
                            <input type="number" class="review-chapter-input" data-filename="${item.filename}" min="1" placeholder="e.g. 5">
                        </div>
                    </div>
                `;
                reviewGrid.appendChild(card);
            }
            reviewPanel.dataset.sessionId = data.session_id;
        }

        // --- Continue Button ---
        continueBtn.addEventListener('click', async () => {
            const sessionId = reviewPanel.dataset.sessionId;
            const inputs = reviewGrid.querySelectorAll('.review-chapter-input');
            const assignments = {};
            let valid = true;

            for (const inp of inputs) {
                const val = inp.value.trim();
                if (!val) { inp.classList.add('input-error'); valid = false; }
                else { inp.classList.remove('input-error'); assignments[inp.dataset.filename] = parseInt(val, 10); }
            }

            if (!valid) { showError('Please assign a chapter number to all files.'); return; }

            errorMsg.style.display = 'none';
            continueBtn.querySelector('.btn-text').style.display = 'none';
            continueBtn.querySelector('.btn-loading').style.display = 'inline-flex';
            continueBtn.disabled = true;

            // Show status bar for streaming
            statusBar.style.display = 'block';
            statusText.textContent = 'Resuming conversion...';
            progressLog.style.display = 'block';
            progressLog.innerHTML = '';
            progressFill.classList.remove('indeterminate');
            progressFill.style.width = '0%';

            try {
                const resp = await fetch('/convert/continue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, assignments }),
                });

                const contentType = resp.headers.get('content-type') || '';

                if (contentType.includes('application/json')) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Continuation failed');
                } else if (contentType.includes('application/x-ndjson')) {
                    await consumeStream(resp);
                }

            } catch (err) {
                showError(err.message);
            } finally {
                continueBtn.querySelector('.btn-text').style.display = 'inline';
                continueBtn.querySelector('.btn-loading').style.display = 'none';
                continueBtn.disabled = false;
            }
        });

        function setLoading(on) {
            if (on) {
                submitBtn.querySelector('.btn-text').style.display = 'none';
                submitBtn.querySelector('.btn-loading').style.display = 'inline-flex';
                submitBtn.disabled = true;
                statusBar.style.display = 'block';
                statusText.textContent = 'Converting‚Ä¶ this may take a while.';
                progressFill.style.width = '0%';
                progressFill.classList.add('indeterminate');
            } else {
                submitBtn.querySelector('.btn-text').style.display = 'inline';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
                submitBtn.disabled = false;
                // progressFill handled by stream end
            }
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
        }

        // --- Init: load browser on page load ---
        loadBrowser('/mangas');
    </script>
</body>

</html>