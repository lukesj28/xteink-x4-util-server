{% extends "base.html" %}

{% block title %}Manga Formatter — CBZ to XTC{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('manga_formatter.static', filename='style.css') }}">
{% endblock %}

{% block content %}
    <div class="container anim-container-pop">
        <header>
            <h1 class="anim-pop-scale"><span>Manga Formatter</span></h1>
            <p class="subtitle anim-fade-slide-up delay-200">Convert CBZ manga to XTC format</p>
        </header>

        <!-- Phase 1: Main Form -->
        <form id="convertForm" enctype="multipart/form-data">
            <!-- Title -->
            <div class="form-group anim-card-pop delay-300">
                <label for="title">Manga Title</label>
                <input type="text" id="title" name="title" placeholder="e.g. Hunter X Hunter" required>
            </div>

            <!-- Source Mode Toggle -->
            <div class="form-group anim-card-pop delay-400">
                <label>Source</label>
                <div class="source-toggle">
                    <button type="button" class="source-btn" data-mode="upload">Upload Files</button>
                    <button type="button" class="source-btn active" data-mode="browse">Browse</button>
                </div>
            </div>

            <!-- Upload Zone (shown in upload mode) -->
            <div class="form-group anim-card-pop delay-500" id="uploadSection" style="display:none;">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <span class="drop-icon">&#128193;</span>
                        <p>Drag & drop CBZ files here</p>
                        <p class="drop-hint">or click to browse</p>
                    </div>
                    <input type="file" id="cbzFiles" name="cbz_files" multiple accept=".cbz" class="file-input">
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Directory Browser (shown in browse mode) -->
            <div class="form-group anim-card-pop delay-500" id="browseSection">
                {% if suwayomi_url %}
                <a href="{{ suwayomi_url }}" target="_blank" class="btn-primary" style="text-decoration: none; display: block; text-align: center; margin-bottom: 1rem; width: auto;" title="Add Manga">
                    ➕ ADD MANGA TO LIBRARY
                </a>
                {% endif %}
                <div class="browser-panel">
                    <div class="browser-breadcrumb" id="breadcrumb" style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="breadcrumbContent"></span>
                        <button type="button" id="refreshBtn" title="Refresh" style="background: none; border: none; color: var(--secondary); font-size: 1.2rem; cursor: pointer; padding: 0 5px;">↻</button>
                    </div>
                    <div class="browser-list" id="browserList">
                        <p class="browser-loading">Loading…</p>
                    </div>
                    <div class="browser-actions" id="browserActions" style="display:none;">
                        <button type="button" id="selectDirBtn" class="btn-scan">Select This Directory</button>
                    </div>
                </div>

                <!-- Selected dir info -->
                <div class="selected-dir-info" id="selectedDirInfo" style="display:none;">
                    <div class="selected-dir-header">
                        <span id="selectedDirLabel"></span>
                        <button type="button" id="changeDirBtn" class="btn-change">Change</button>
                    </div>
                    <div class="file-list" id="cbzPreviewList"></div>
                </div>
            </div>

            <!-- Settings -->
            <details class="settings-panel anim-card-pop delay-600">
                <summary>Conversion Settings</summary>
                <div class="settings-grid">
                    <div class="setting">
                        <label for="dithering">Dithering</label>
                        <div class="toggle-wrap">
                            <input type="checkbox" id="dithering" name="dithering" checked>
                            <label for="dithering" class="toggle"></label>
                            <span class="toggle-label" id="ditherLabel">ON</span>
                        </div>
                    </div>

                    <div class="setting">
                        <label for="long_strip">Long Strip Format</label>
                        <div class="toggle-wrap">
                            <input type="checkbox" id="long_strip" name="long_strip">
                            <label for="long_strip" class="toggle"></label>
                            <span class="toggle-label" id="longStripLabel">OFF</span>
                        </div>
                    </div>

                    <div class="setting" id="overlapSetting" style="display:none;">
                        <label for="overlap">Strip Overlap <span id="overlapVal" class="badge">33%</span></label>
                        <input type="range" id="overlap" name="overlap" min="0" max="50" value="33">
                    </div>

                    <div class="setting">
                        <label for="contrast">Contrast <span id="contrastVal" class="badge">4</span></label>
                        <input type="range" id="contrast" name="contrast" min="0" max="8" value="4">
                    </div>

                    <div class="setting">
                        <label for="target_width">Width (px)</label>
                        <input type="number" id="target_width" name="target_width" value="480" min="100" max="2000">
                    </div>

                    <div class="setting">
                        <label for="target_height">Height (px)</label>
                        <input type="number" id="target_height" name="target_height" value="800" min="100" max="2000">
                    </div>
                </div>
            </details>

            <!-- Submit -->
            <button type="submit" id="submitBtn" class="btn-primary anim-card-pop delay-700" disabled>
                <span class="btn-text">Convert & Download</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span> Converting…
                </span>
            </button>
        </form>

        <!-- Phase 2: Review Panel (hidden initially) -->
        <div class="review-panel" id="reviewPanel" style="display:none;">
            <h2>Manual Chapter Assignment</h2>
            <p class="review-intro">The following files couldn't be auto-assigned chapter numbers. Please review and
                assign them.</p>

            <div class="recognized-summary" id="recognizedSummary"></div>

            <div class="review-grid" id="reviewGrid"></div>

            <button type="button" id="continueBtn" class="btn-primary">
                <span class="btn-text">Continue & Download</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span> Processing…
                </span>
            </button>
        </div>

        <!-- Progress / Status -->
        <div class="status-bar" id="statusBar" style="display:none;">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p class="status-text" id="statusText">Processing…</p>
            <div class="progress-log" id="progressLog" style="display:none;"></div>
        </div>

        <!-- Error -->
        <div class="error-msg" id="errorMsg" style="display:none;"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // --- DOM refs ---
        const form = document.getElementById('convertForm');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('cbzFiles');
        const fileList = document.getElementById('fileList');
        const submitBtn = document.getElementById('submitBtn');
        const statusBar = document.getElementById('statusBar');
        const statusText = document.getElementById('statusText');
        const progressFill = document.getElementById('progressFill');
        const progressLog = document.getElementById('progressLog');
        const errorMsg = document.getElementById('errorMsg');
        const contrastSlider = document.getElementById('contrast');
        const contrastVal = document.getElementById('contrastVal');
        const ditherToggle = document.getElementById('dithering');
        const ditherLabel = document.getElementById('ditherLabel');
        const longStripToggle = document.getElementById('long_strip');
        const longStripLabel = document.getElementById('longStripLabel');
        const overlapSetting = document.getElementById('overlapSetting');
        const overlapSlider = document.getElementById('overlap');
        const overlapVal = document.getElementById('overlapVal');
        const uploadSection = document.getElementById('uploadSection');
        const browseSection = document.getElementById('browseSection');
        const breadcrumb = document.getElementById('breadcrumb');
        const browserList = document.getElementById('browserList');
        const browserActions = document.getElementById('browserActions');
        const selectDirBtn = document.getElementById('selectDirBtn');
        const selectedDirInfo = document.getElementById('selectedDirInfo');
        const selectedDirLabel = document.getElementById('selectedDirLabel');
        const changeDirBtn = document.getElementById('changeDirBtn');
        const cbzPreviewList = document.getElementById('cbzPreviewList');
        const reviewPanel = document.getElementById('reviewPanel');
        const reviewGrid = document.getElementById('reviewGrid');
        const recognizedSummary = document.getElementById('recognizedSummary');
        const continueBtn = document.getElementById('continueBtn');
        const refreshBtn = document.getElementById('refreshBtn');

        let sourceMode = 'browse';
        let selectedHostPath = null;
        let currentBrowsePath = '/mangas';

        // --- Source Mode Toggle ---
        document.querySelectorAll('.source-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.source-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sourceMode = btn.dataset.mode;

                if (sourceMode === 'upload') {
                    uploadSection.style.display = '';
                    browseSection.style.display = 'none';
                } else {
                    uploadSection.style.display = 'none';
                    browseSection.style.display = '';
                    if (!selectedHostPath) loadBrowser(currentBrowsePath);
                }
                updateSubmitState();
            });
        });

        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadBrowser(currentBrowsePath);
            });
        }

        // --- Directory Browser ---
        async function loadBrowser(path) {
            currentBrowsePath = path;
            browserList.innerHTML = '<p class="browser-loading">Loading…</p>';
            browserActions.style.display = 'none';
            errorMsg.style.display = 'none';

            try {
                const resp = await fetch(`/manga-formatter/browse?path=${encodeURIComponent(path)}`);
                const data = await resp.json();

                if (!resp.ok) {
                    browserList.innerHTML = `<p class="browser-empty">${data.error}</p>`;
                    return;
                }

                // Build breadcrumb
                buildBreadcrumb(data.current_path);

                // Build listing
                browserList.innerHTML = '';

                // Back button (if not at root)
                if (data.parent) {
                    const back = document.createElement('div');
                    back.className = 'browser-item browser-dir';
                    back.innerHTML = '<span>..</span>';
                    back.addEventListener('click', () => loadBrowser(data.parent));
                    browserList.appendChild(back);
                }

                if (data.dirs.length === 0 && data.files.length === 0) {
                    const empty = document.createElement('p');
                    empty.className = 'browser-empty';
                    empty.textContent = 'Empty directory';
                    browserList.appendChild(empty);
                }

                // Directories
                for (const dir of data.dirs) {
                    const el = document.createElement('div');
                    el.className = 'browser-item browser-dir';
                    el.innerHTML = `<span>${dir.name}</span>`;
                    el.addEventListener('click', () => loadBrowser(dir.path));
                    browserList.appendChild(el);
                }

                // Files
                for (const file of data.files) {
                    const el = document.createElement('div');
                    el.className = 'browser-item browser-file';
                    el.innerHTML = `<span>${file.name}</span><span class="file-size">${file.size}</span>`;
                    browserList.appendChild(el);
                }

                // Show select button if there are CBZ files
                const hasCbz = data.files.some(f => f.name.toLowerCase().endsWith('.cbz'));
                const cbzCount = data.files.filter(f => f.name.toLowerCase().endsWith('.cbz')).length;
                if (hasCbz) {
                    selectDirBtn.textContent = `Select (${cbzCount} CBZ file${cbzCount !== 1 ? 's' : ''})`;
                    browserActions.style.display = '';
                } else if (data.dirs.length > 0) {
                    browserActions.style.display = 'none';
                } else {
                    selectDirBtn.textContent = 'Select This Directory';
                    browserActions.style.display = '';
                }

            } catch (err) {
                browserList.innerHTML = `<p class="browser-empty">${err.message}</p>`;
            }
        }

        function buildBreadcrumb(fullPath) {
            const breadcrumbContent = document.getElementById('breadcrumbContent');
            if (!breadcrumbContent) return; // Safety check
            breadcrumbContent.innerHTML = '';
            
            const base = '/mangas';
            const relative = fullPath.replace(base, '') || '';
            const parts = relative.split('/').filter(Boolean);

            // Root crumb
            const root = document.createElement('span');
            root.className = 'crumb';
            root.textContent = 'mangas';
            root.addEventListener('click', () => loadBrowser(base));
            breadcrumbContent.appendChild(root);

            let accumulated = base;
            for (const part of parts) {
                accumulated += '/' + part;
                const sep = document.createElement('span');
                sep.className = 'crumb-sep';
                sep.textContent = ' / ';
                breadcrumbContent.appendChild(sep);

                const crumb = document.createElement('span');
                crumb.className = 'crumb';
                crumb.textContent = part;
                const target = accumulated;
                crumb.addEventListener('click', () => loadBrowser(target));
                breadcrumbContent.appendChild(crumb);
            }
        }

        // Select directory
        selectDirBtn.addEventListener('click', async () => {
            selectedHostPath = currentBrowsePath;

            try {
                const resp = await fetch(`/manga-formatter/browse?path=${encodeURIComponent(selectedHostPath)}`);
                const data = await resp.json();

                const cbzFiles = data.files.filter(f => f.name.toLowerCase().endsWith('.cbz'));

                selectedDirLabel.textContent = `${selectedHostPath.replace('/mangas', 'mangas')} — ${cbzFiles.length} CBZ file${cbzFiles.length !== 1 ? 's' : ''}`;
                cbzPreviewList.innerHTML = '';
                for (const f of cbzFiles) {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `<span class="file-name">${f.name}</span><span class="file-size">${f.size}</span>`;
                    cbzPreviewList.appendChild(div);
                }

                document.querySelector('.browser-panel').style.display = 'none';
                selectedDirInfo.style.display = '';
                updateSubmitState();

            } catch (err) {
                showError(err.message);
            }
        });

        // Change directory (go back to browser)
        changeDirBtn.addEventListener('click', () => {
            selectedHostPath = null;
            selectedDirInfo.style.display = 'none';
            document.querySelector('.browser-panel').style.display = '';
            updateSubmitState();
        });

        // --- Drop Zone ---
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            fileInput.files = e.dataTransfer.files;
            updateFileList();
        });
        fileInput.addEventListener('change', updateFileList);

        function updateFileList() {
            fileList.innerHTML = '';
            const files = fileInput.files;
            if (files.length === 0) { updateSubmitState(); return; }
            for (const f of files) {
                const div = document.createElement('div');
                div.className = 'file-item';
                const sizeMB = (f.size / 1024 / 1024).toFixed(1);
                div.innerHTML = `<span class="file-name">${f.name}</span><span class="file-size">${sizeMB} MB</span>`;
                fileList.appendChild(div);
            }
            updateSubmitState();
        }

        function updateSubmitState() {
            if (sourceMode === 'upload') {
                submitBtn.disabled = !fileInput.files.length;
            } else {
                submitBtn.disabled = !selectedHostPath;
            }
        }

        // --- Settings ---
        contrastSlider.addEventListener('input', () => { contrastVal.textContent = contrastSlider.value; });
        overlapSlider.addEventListener('input', () => { overlapVal.textContent = overlapSlider.value + '%'; });
        ditherToggle.addEventListener('change', () => { ditherLabel.textContent = ditherToggle.checked ? 'ON' : 'OFF'; });
        longStripToggle.addEventListener('change', () => { 
            longStripLabel.textContent = longStripToggle.checked ? 'ON' : 'OFF'; 
            overlapSetting.style.display = longStripToggle.checked ? 'block' : 'none';
        });

        // --- Form Submit ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.style.display = 'none';

            const title = document.getElementById('title').value.trim();
            if (!title) { showError('Please enter a manga title.'); return; }

            if (sourceMode === 'upload' && !fileInput.files.length) {
                showError('Please select CBZ files.'); return;
            }
            if (sourceMode === 'browse' && !selectedHostPath) {
                showError('Please select a directory.'); return;
            }

            const fd = new FormData();
            fd.append('title', title);
            fd.append('source_mode', sourceMode === 'browse' ? 'hostdir' : 'upload');
            fd.append('dithering', ditherToggle.checked ? 'true' : 'false');
            fd.append('long_strip', longStripToggle.checked ? 'true' : 'false');
            fd.append('overlap', overlapSlider.value);
            fd.append('contrast', contrastSlider.value);
            fd.append('target_width', document.getElementById('target_width').value);
            fd.append('target_height', document.getElementById('target_height').value);

            if (sourceMode === 'upload') {
                for (const f of fileInput.files) {
                    fd.append('cbz_files', f);
                }
            } else {
                fd.append('host_path', selectedHostPath);
            }

            setLoading(true);

            try {
                const resp = await fetch('/manga-formatter/convert', { method: 'POST', body: fd });

                const contentType = resp.headers.get('content-type') || '';

                if (contentType.includes('application/json')) {
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Conversion failed');

                    if (data.status === 'needs_review') {
                        showReviewPanel(data);
                        setLoading(false);
                        form.style.display = 'none';
                        return;
                    }
                } else if (contentType.includes('application/x-ndjson')) {
                    await consumeStream(resp);
                } else {
                    const text = await resp.text();
                    console.error('Unexpected Response:', resp.status, contentType, text);
                    throw new Error(`Unexpected response: ${resp.status} ${resp.statusText} (${contentType}). Check console for details.`);
                }

            } catch (err) {
                showError(err.message);
                statusBar.style.display = 'none';
            } finally {
                if (statusBar.style.display === 'none') setLoading(false);
            }
        });

        // --- Stream Consumer ---
        async function consumeStream(resp) {
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            statusText.textContent = 'Starting conversion...';
            progressFill.classList.remove('indeterminate');
            progressFill.style.width = '0%';
            progressLog.style.display = 'block';
            progressLog.innerHTML = '';

            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            handleStreamMessage(msg);
                        } catch (e) {
                            console.error('Invalid JSON line:', line);
                        }
                    }
                }
            } catch (err) {
                showError('Stream error: ' + err.message);
            } finally {
                setLoading(false);
            }
        }

        function handleStreamMessage(msg) {
            if (msg.type === 'progress') {
                const pct = Math.round((msg.current / msg.total) * 100);
                progressFill.style.width = `${pct}%`;
                statusText.textContent = msg.message;

                const entry = document.createElement('div');
                entry.textContent = `[${pct}%] ${msg.message}`;
                progressLog.appendChild(entry);
                progressLog.scrollTop = progressLog.scrollHeight;

            } else if (msg.type === 'done') {
                statusText.textContent = 'Conversion Complete!';
                progressFill.style.width = '100%';

                const a = document.createElement('a');
                a.href = msg.download_url;
                a.download = '';
                document.body.appendChild(a);
                a.click();
                a.remove();

            } else if (msg.type === 'error') {
                showError(msg.message);
            }
        }

        // --- Review Panel ---
        function showReviewPanel(data) {
            reviewPanel.style.display = '';
            if (data.recognized_count > 0) {
                recognizedSummary.innerHTML =
                    `<p class="recognized-info"><strong>${data.recognized_count}</strong> chapter${data.recognized_count !== 1 ? 's' : ''} auto-recognized: ${data.recognized_chapters.join(', ')}</p>`;
            } else {
                recognizedSummary.innerHTML = '<p class="recognized-info">No chapters were auto-recognized.</p>';
            }
            reviewGrid.innerHTML = '';
            for (const item of data.unrecognized) {
                const card = document.createElement('div');
                card.className = 'review-card';
                card.innerHTML = `
                    <img src="${item.preview_url}" alt="${item.filename}" class="review-thumb" loading="lazy">
                    <div class="review-info">
                        <span class="review-filename">${item.filename}</span>
                        <div class="review-input-wrap">
                            <label>Chapter #</label>
                            <input type="number" class="review-chapter-input" data-filename="${item.filename}" min="1" placeholder="e.g. 5">
                        </div>
                    </div>
                `;
                reviewGrid.appendChild(card);
            }
            reviewPanel.dataset.sessionId = data.session_id;
        }

        // --- Continue Button ---
        continueBtn.addEventListener('click', async () => {
            const sessionId = reviewPanel.dataset.sessionId;
            const inputs = reviewGrid.querySelectorAll('.review-chapter-input');
            const assignments = {};
            let valid = true;

            for (const inp of inputs) {
                const val = inp.value.trim();
                if (!val) { inp.classList.add('input-error'); valid = false; }
                else { inp.classList.remove('input-error'); assignments[inp.dataset.filename] = parseInt(val, 10); }
            }

            if (!valid) { showError('Please assign a chapter number to all files.'); return; }

            errorMsg.style.display = 'none';
            continueBtn.querySelector('.btn-text').style.display = 'none';
            continueBtn.querySelector('.btn-loading').style.display = 'inline-flex';
            continueBtn.disabled = true;

            statusBar.style.display = 'block';
            statusText.textContent = 'Resuming conversion...';
            progressLog.style.display = 'block';
            progressLog.innerHTML = '';
            progressFill.classList.remove('indeterminate');
            progressFill.style.width = '0%';

            try {
                const resp = await fetch('/manga-formatter/convert/continue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId, assignments }),
                });

                const contentType = resp.headers.get('content-type') || '';

                if (contentType.includes('application/json')) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Continuation failed');
                } else if (contentType.includes('application/x-ndjson')) {
                    await consumeStream(resp);
                }

            } catch (err) {
                showError(err.message);
            } finally {
                continueBtn.querySelector('.btn-text').style.display = 'inline';
                continueBtn.querySelector('.btn-loading').style.display = 'none';
                continueBtn.disabled = false;
            }
        });

        function setLoading(on) {
            if (on) {
                submitBtn.querySelector('.btn-text').style.display = 'none';
                submitBtn.querySelector('.btn-loading').style.display = 'inline-flex';
                submitBtn.disabled = true;
                statusBar.style.display = 'block';
                statusText.textContent = 'Converting… this may take a while.';
                progressFill.style.width = '0%';
                progressFill.classList.add('indeterminate');
            } else {
                submitBtn.querySelector('.btn-text').style.display = 'inline';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.style.display = 'block';
        }

        // --- Init: load browser on page load ---
        loadBrowser('/mangas');
    </script>
{% endblock %}
